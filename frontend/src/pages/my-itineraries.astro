---
import Layout from "../layouts/Layout.astro";
import PageHeader from "../components/PageHeader.astro";
---

<Layout>
  <Fragment slot="head">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600&family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </Fragment>

  <main class="min-h-screen px-5 pb-14 pt-10 sm:px-8 lg:px-14">
    <div class="mx-auto flex max-w-4xl flex-col gap-8">
      <PageHeader
        label="My Trips"
        title="Saved itineraries"
        description="Pick up where you left off or revisit a past adventure."
      />

      <div id="trips-loading" class="flex items-center justify-center py-16">
        <p class="text-sm text-[#7f6b5c]">Loading your trips&hellip;</p>
      </div>

      <p id="trips-error" class="hidden text-sm font-medium text-red-600"></p>

      <div id="trips-list" class="hidden flex-col gap-4"></div>

      <div id="trips-empty" class="hidden flex-col items-center gap-4 py-12 text-center">
        <p class="text-base text-[#5e4b41]">You haven't saved any itineraries yet.</p>
        <a
          href="/constraints"
          class="inline-flex items-center justify-center rounded-full bg-[#2b2623] px-6 py-2.5 text-sm font-medium text-white transition hover:bg-[#3d3330]"
        >
          Plan a Day
        </a>
      </div>
    </div>
  </main>

  <script>
    import { getItineraries } from "../scripts/api";
    import { getUser } from "../scripts/auth";

    const loadingEl = document.getElementById("trips-loading")!;
    const errorEl = document.getElementById("trips-error")!;
    const listEl = document.getElementById("trips-list")!;
    const emptyEl = document.getElementById("trips-empty")!;

    async function init() {
      const user = getUser();
      if (!user) return;

      try {
        const ids = await getItineraries(user.email);

        loadingEl.classList.add("hidden");

        if (!ids.length) {
          emptyEl.classList.remove("hidden");
          emptyEl.classList.add("flex");
          return;
        }

        listEl.classList.remove("hidden");
        listEl.classList.add("flex");

        ids.forEach((id, index) => {
          const link = document.createElement("a");
          link.href = `/itinerary?id=${encodeURIComponent(id)}`;
          link.className =
            "flex items-center justify-between rounded-2xl border border-white/60 bg-white/80 px-6 py-5 shadow-md backdrop-blur transition hover:-translate-y-0.5 hover:shadow-lg";
          link.innerHTML = `
            <div class="flex flex-col gap-1">
              <span class="text-sm font-semibold text-[#2b2623]">Itinerary ${index + 1}</span>
              <span class="text-xs text-[#8d7666]">${id}</span>
            </div>
            <span class="text-[#a08a7c]">&rarr;</span>
          `;
          listEl.appendChild(link);
        });
      } catch (err) {
        loadingEl.classList.add("hidden");
        errorEl.textContent = err instanceof Error ? err.message : "Failed to load trips.";
        errorEl.classList.remove("hidden");
      }
    }

    init();
  </script>
</Layout>
